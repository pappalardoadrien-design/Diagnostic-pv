<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Contr√¥les Visuels IEC 62446-1 | DiagPV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Mobile-first optimizations */
        body { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .checklist-item { min-height: 60px; }
        .btn-large { min-height: 48px; min-width: 48px; }
        .sticky-header { position: sticky; top: 0; z-index: 50; }
        
        /* Swipe gestures visual feedback */
        .swipe-conform { background: linear-gradient(90deg, transparent, #22c55e33); }
        .swipe-non-conform { background: linear-gradient(90deg, transparent, #ef444433); }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header Sticky -->
    <header class="sticky-header bg-gray-800 border-b-2 border-green-400 shadow-lg">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i class="fas fa-clipboard-check text-2xl text-green-400"></i>
                    <div>
                        <h1 class="text-lg font-bold">Contr√¥les Visuels</h1>
                        <p class="text-xs text-gray-400">IEC 62446-1</p>
                    </div>
                </div>
                <button onclick="showMenu()" class="btn-large px-3 bg-gray-700 rounded-lg">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
            
            <!-- Progress Bar -->
            <div id="progressBar" class="flex items-center gap-2 text-sm">
                <div class="flex-1 bg-gray-700 rounded-full h-2">
                    <div id="progressFill" class="bg-green-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                </div>
                <span id="progressText" class="text-xs whitespace-nowrap">0/36</span>
            </div>
        </div>
    </header>

    <main class="pb-20">
        <!-- Loading State -->
        <div id="loadingState" class="p-8 text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-green-400 mb-4"></i>
            <p>Chargement inspection...</p>
        </div>

        <!-- Create Inspection -->
        <div id="createForm" class="hidden p-4">
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <h2 class="text-xl font-bold mb-4 text-green-400">
                    <i class="fas fa-plus-circle mr-2"></i>
                    Nouvelle Inspection
                </h2>
                <form id="newInspectionForm" class="space-y-3">
                    <input type="text" id="projectName" required placeholder="Nom projet *" 
                           class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg px-3 py-2 text-white">
                    <input type="text" id="clientName" required placeholder="Client *" 
                           class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg px-3 py-2 text-white">
                    <input type="text" id="location" required placeholder="Localisation *" 
                           class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg px-3 py-2 text-white">
                    <input type="date" id="inspectionDate" required 
                           class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg px-3 py-2 text-white">
                    <input type="text" id="inspectorName" placeholder="Inspecteur" 
                           class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg px-3 py-2 text-white">
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 py-3 rounded-lg font-bold">
                        <i class="fas fa-rocket mr-2"></i>CR√âER INSPECTION
                    </button>
                </form>
            </div>
        </div>

        <!-- Checklist Items -->
        <div id="checklistContainer" class="hidden">
            <!-- Category Filter -->
            <div class="sticky top-[76px] bg-gray-800 border-b border-gray-700 p-2 z-40 overflow-x-auto">
                <div class="flex gap-2 whitespace-nowrap">
                    <button onclick="filterCategory('ALL')" class="filter-btn active px-3 py-1 rounded-full text-sm font-bold bg-gray-700">
                        TOUS (36)
                    </button>
                    <button onclick="filterCategory('MECHANICAL')" class="filter-btn px-3 py-1 rounded-full text-sm font-bold bg-gray-700">
                        <i class="fas fa-cog mr-1"></i>M√âCA (12)
                    </button>
                    <button onclick="filterCategory('ELECTRICAL')" class="filter-btn px-3 py-1 rounded-full text-sm font-bold bg-gray-700">
                        <i class="fas fa-bolt mr-1"></i>√âLEC (10)
                    </button>
                    <button onclick="filterCategory('DOCUMENTATION')" class="filter-btn px-3 py-1 rounded-full text-sm font-bold bg-gray-700">
                        <i class="fas fa-file-alt mr-1"></i>DOC (8)
                    </button>
                    <button onclick="filterCategory('SAFETY')" class="filter-btn px-3 py-1 rounded-full text-sm font-bold bg-gray-700">
                        <i class="fas fa-shield-alt mr-1"></i>S√âCU (6)
                    </button>
                </div>
            </div>

            <!-- Items List -->
            <div id="itemsList" class="p-2 space-y-2"></div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden p-8 text-center">
            <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
            <p id="errorMessage">Erreur</p>
            <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-blue-600 rounded-lg">
                Recharger
            </button>
        </div>
    </main>

    <!-- Bottom Action Bar -->
    <div id="bottomBar" class="hidden fixed bottom-0 left-0 right-0 bg-gray-800 border-t-2 border-green-400 p-3 flex gap-2">
        <button onclick="showStats()" class="flex-1 bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-bold">
            <i class="fas fa-chart-bar mr-1"></i><span class="hidden sm:inline">STATS</span>
        </button>
        <button onclick="addDefect()" class="flex-1 bg-orange-600 hover:bg-orange-700 py-3 rounded-lg font-bold">
            <i class="fas fa-exclamation-triangle mr-1"></i><span class="hidden sm:inline">D√âFAUT</span>
        </button>
        <button onclick="generateReport()" class="flex-1 bg-green-600 hover:bg-green-700 py-3 rounded-lg font-bold">
            <i class="fas fa-file-pdf mr-1"></i><span class="hidden sm:inline">RAPPORT</span>
        </button>
    </div>

    <!-- Item Detail Modal -->
    <div id="itemModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 overflow-auto p-4">
        <div class="bg-gray-800 rounded-lg max-w-2xl mx-auto my-8 border-2 border-green-400">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 id="modalTitle" class="text-lg font-bold"></h3>
                <button onclick="closeModal()" class="text-2xl">&times;</button>
            </div>
            <div class="p-4 space-y-4">
                <div id="modalContent"></div>
                
                <!-- Conformity Buttons -->
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="updateItem('conform')" class="bg-green-600 hover:bg-green-700 py-3 rounded-lg font-bold">
                        <i class="fas fa-check mr-1"></i>CONFORME
                    </button>
                    <button onclick="updateItem('non_conform')" class="bg-red-600 hover:bg-red-700 py-3 rounded-lg font-bold">
                        <i class="fas fa-times mr-1"></i>NON CONFORME
                    </button>
                    <button onclick="updateItem('not_applicable')" class="bg-gray-600 hover:bg-gray-700 py-3 rounded-lg font-bold">
                        <i class="fas fa-ban mr-1"></i>N/A
                    </button>
                </div>

                <!-- Observation -->
                <textarea id="observationText" placeholder="Observations..." rows="3"
                          class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-2"></textarea>
                
                <button onclick="saveObservation()" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-bold">
                    <i class="fas fa-save mr-2"></i>ENREGISTRER
                </button>
            </div>
        </div>
    </div>

    <!-- Defect Creation Modal -->
    <div id="defectModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 overflow-auto p-4">
        <div class="bg-gray-800 rounded-lg max-w-3xl mx-auto my-8 border-2 border-orange-400">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-orange-400">
                    <i class="fas fa-exclamation-triangle mr-2"></i>NOUVEAU D√âFAUT
                </h3>
                <button onclick="closeDefectModal()" class="text-2xl">&times;</button>
            </div>
            <div class="p-4 space-y-4 max-h-[70vh] overflow-y-auto">
                
                <!-- Localisation -->
                <div class="space-y-2">
                    <label class="font-bold text-green-400">üéØ LOCALISATION</label>
                    <input id="defectLocation" type="text" placeholder="Ex: Module String 1 Position 12, Onduleur principal, etc." 
                           class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3" />
                </div>

                <!-- Type √âquipement -->
                <div class="space-y-2">
                    <label class="font-bold text-green-400">üîß TYPE √âQUIPEMENT</label>
                    <select id="defectEquipmentType" onchange="updateDefectTypes()" 
                            class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3">
                        <option value="">-- S√©lectionner --</option>
                        <option value="MODULE">Module PV</option>
                        <option value="STRUCTURE">Structure Support</option>
                        <option value="CABLE">C√¢blage</option>
                        <option value="PROTECTION">Protection √âlectrique</option>
                        <option value="CONNECTOR">Connecteur (MC4, etc.)</option>
                        <option value="JUNCTION_BOX">Bo√Æte de Jonction</option>
                        <option value="INVERTER">Onduleur</option>
                        <option value="OTHER">Autre</option>
                    </select>
                </div>

                <!-- Type D√©faut -->
                <div class="space-y-2">
                    <label class="font-bold text-green-400">‚ö†Ô∏è TYPE D√âFAUT</label>
                    <select id="defectType" class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3">
                        <option value="">-- S√©lectionner type √©quipement d'abord --</option>
                    </select>
                </div>

                <!-- Cat√©gorie -->
                <div class="space-y-2">
                    <label class="font-bold text-green-400">üìÇ CAT√âGORIE</label>
                    <select id="defectCategory" class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3">
                        <option value="MECHANICAL">MECHANICAL - M√©canique</option>
                        <option value="ELECTRICAL">ELECTRICAL - √âlectrique</option>
                        <option value="THERMAL">THERMAL - Thermique</option>
                        <option value="VISUAL">VISUAL - Visuel</option>
                    </select>
                </div>

                <!-- S√©v√©rit√© -->
                <div class="space-y-2">
                    <label class="font-bold text-green-400">üö® S√âV√âRIT√â</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="selectSeverity('critical')" id="severityCritical"
                                class="severity-btn bg-gray-700 hover:bg-red-600 border-2 border-gray-600 py-3 rounded-lg font-bold">
                            üî¥ CRITIQUE
                        </button>
                        <button onclick="selectSeverity('major')" id="severityMajor"
                                class="severity-btn bg-gray-700 hover:bg-orange-600 border-2 border-gray-600 py-3 rounded-lg font-bold">
                            üü† MAJEUR
                        </button>
                        <button onclick="selectSeverity('minor')" id="severityMinor"
                                class="severity-btn bg-gray-700 hover:bg-yellow-600 border-2 border-gray-600 py-3 rounded-lg font-bold">
                            üü° MINEUR
                        </button>
                    </div>
                </div>

                <!-- Urgence -->
                <div class="space-y-2">
                    <label class="font-bold text-green-400">‚è±Ô∏è URGENCE</label>
                    <select id="defectUrgency" class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3">
                        <option value="immediate">üî• IMM√âDIATE - Action sous 24h</option>
                        <option value="short_term">‚ö° COURT TERME - Action sous 1 semaine</option>
                        <option value="medium_term">üìÖ MOYEN TERME - Action sous 1 mois</option>
                        <option value="long_term">üìÜ LONG TERME - Action sous 3 mois</option>
                    </select>
                </div>

                <!-- Description -->
                <div class="space-y-2">
                    <label class="font-bold text-green-400">üìù DESCRIPTION D√âTAILL√âE</label>
                    <textarea id="defectDescription" rows="3" placeholder="D√©crivez pr√©cis√©ment le d√©faut observ√©..." 
                              class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3"></textarea>
                </div>

                <!-- Impact Potentiel -->
                <div class="space-y-2">
                    <label class="font-bold text-green-400">üí• IMPACT POTENTIEL</label>
                    <textarea id="defectImpact" rows="2" placeholder="Cons√©quences possibles (perte production, risque s√©curit√©, etc.)..." 
                              class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3"></textarea>
                </div>

                <!-- Action Recommand√©e -->
                <div class="space-y-2">
                    <label class="font-bold text-green-400">‚úÖ ACTION RECOMMAND√âE</label>
                    <textarea id="defectAction" rows="2" placeholder="Action corrective pr√©conis√©e..." 
                              class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3"></textarea>
                </div>

                <!-- R√©f√©rence Norme -->
                <div class="space-y-2">
                    <label class="font-bold text-green-400">üìã R√âF√âRENCE NORME (optionnel)</label>
                    <input id="defectNormRef" type="text" placeholder="Ex: IEC 62446-1 Section 6.2, NF C 15-100..." 
                           class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3" />
                </div>

                <!-- Violation Norme -->
                <div class="space-y-2">
                    <label class="font-bold text-green-400">‚öñÔ∏è VIOLATION NORME</label>
                    <div class="flex gap-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="normViolation" value="true" class="mr-2" />
                            <span>Oui - Non conforme</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="normViolation" value="false" checked class="mr-2" />
                            <span>Non - Conforme norme</span>
                        </label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2 pt-4 border-t border-gray-700">
                    <button onclick="closeDefectModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 py-3 rounded-lg font-bold">
                        <i class="fas fa-times mr-2"></i>ANNULER
                    </button>
                    <button onclick="submitDefect()" class="flex-1 bg-orange-600 hover:bg-orange-700 py-3 rounded-lg font-bold">
                        <i class="fas fa-check mr-2"></i>CR√âER D√âFAUT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentInspection = null;
        let checklistItems = [];
        let currentFilter = 'ALL';
        let currentItemId = null;
        let selectedSeverity = null;

        // Initialize
        window.addEventListener('DOMContentLoaded', init);

        async function init() {
            // Check URL for inspection token
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token) {
                await loadInspection(token);
            } else {
                showCreateForm();
            }
        }

        function showCreateForm() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('createForm').classList.remove('hidden');
            
            // Set today's date
            document.getElementById('inspectionDate').valueAsDate = new Date();
            
            document.getElementById('newInspectionForm').onsubmit = createInspection;
        }

        async function createInspection(e) {
            e.preventDefault();
            
            const formData = {
                projectName: document.getElementById('projectName').value,
                clientName: document.getElementById('clientName').value,
                location: document.getElementById('location').value,
                inspectionDate: document.getElementById('inspectionDate').value,
                inspectorName: document.getElementById('inspectorName').value || undefined
            };

            try {
                const response = await axios.post('/api/visual/inspection/create', formData);
                const token = response.data.inspection.inspectionToken;
                
                // Redirect to inspection with token
                window.location.href = `?token=${token}`;
                
            } catch (error) {
                alert('Erreur cr√©ation : ' + (error.response?.data?.error || error.message));
            }
        }

        async function loadInspection(token) {
            try {
                const response = await axios.get(`/api/visual/inspection/${token}`);
                currentInspection = response.data.inspection;
                checklistItems = response.data.items;
                
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('checklistContainer').classList.remove('hidden');
                document.getElementById('bottomBar').classList.remove('hidden');
                
                updateProgress();
                renderItems();
                
            } catch (error) {
                showError(error.response?.data?.error || error.message);
            }
        }

        function renderItems() {
            const container = document.getElementById('itemsList');
            const filtered = currentFilter === 'ALL' 
                ? checklistItems 
                : checklistItems.filter(item => item.category === currentFilter);
            
            container.innerHTML = filtered.map(item => `
                <div onclick="openItem(${item.id})" 
                     class="checklist-item bg-gray-800 rounded-lg p-3 border-2 ${getItemBorderColor(item)} cursor-pointer active:scale-98">
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full ${getItemBgColor(item)} flex items-center justify-center font-bold">
                            ${item.item_code}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-sm leading-tight mb-1">${item.item_description}</div>
                            <div class="flex items-center gap-2 text-xs">
                                <span class="px-2 py-0.5 rounded ${getCategoryColor(item.category)}">${getCategoryLabel(item.category)}</span>
                                <span class="text-gray-400">${getConformityLabel(item.conformity)}</span>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-600"></i>
                    </div>
                </div>
            `).join('');
        }

        function openItem(itemId) {
            currentItemId = itemId;
            const item = checklistItems.find(i => i.id === itemId);
            
            document.getElementById('modalTitle').textContent = `${item.item_code} - ${item.category}`;
            document.getElementById('modalContent').innerHTML = `
                <div class="space-y-2 text-sm">
                    <p class="font-bold">${item.item_description}</p>
                    <p class="text-gray-400"><strong>Sous-cat√©gorie:</strong> ${item.subcategory || '-'}</p>
                    <p class="text-gray-400"><strong>Criticit√©:</strong> ${item.severity}</p>
                    ${item.observation ? `<p class="bg-gray-700 p-2 rounded"><strong>Observation:</strong> ${item.observation}</p>` : ''}
                </div>
            `;
            
            document.getElementById('observationText').value = item.observation || '';
            document.getElementById('itemModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('itemModal').classList.add('hidden');
            currentItemId = null;
        }

        async function updateItem(conformity) {
            if (!currentItemId) return;
            
            try {
                await axios.put(`/api/visual/inspection/${currentInspection.inspection_token}/item/${currentItemId}`, {
                    status: 'checked',
                    conformity: conformity,
                    checkedBy: currentInspection.inspector_name || 'Inspector'
                });
                
                // Update local data
                const item = checklistItems.find(i => i.id === currentItemId);
                if (item) {
                    item.status = 'checked';
                    item.conformity = conformity;
                }
                
                updateProgress();
                renderItems();
                closeModal();
                
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        async function saveObservation() {
            if (!currentItemId) return;
            
            const observation = document.getElementById('observationText').value;
            
            try {
                await axios.put(`/api/visual/inspection/${currentInspection.inspection_token}/item/${currentItemId}`, {
                    observation: observation
                });
                
                // Update local data
                const item = checklistItems.find(i => i.id === currentItemId);
                if (item) {
                    item.observation = observation;
                }
                
                alert('Observation enregistr√©e');
                
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }

        function filterCategory(category) {
            currentFilter = category;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-green-600');
                btn.classList.add('bg-gray-700');
            });
            event.target.closest('.filter-btn').classList.add('active', 'bg-green-600');
            event.target.closest('.filter-btn').classList.remove('bg-gray-700');
            
            renderItems();
        }

        function updateProgress() {
            const checked = checklistItems.filter(i => i.status === 'checked').length;
            const total = checklistItems.length;
            const percent = Math.round((checked / total) * 100);
            
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${checked}/${total}`;
        }

        function showStats() {
            const stats = {
                total: checklistItems.length,
                checked: checklistItems.filter(i => i.status === 'checked').length,
                conform: checklistItems.filter(i => i.conformity === 'conform').length,
                nonConform: checklistItems.filter(i => i.conformity === 'non_conform').length,
                notApplicable: checklistItems.filter(i => i.conformity === 'not_applicable').length
            };
            
            alert(`STATISTIQUES\n\n` +
                  `Total: ${stats.total}\n` +
                  `V√©rifi√©s: ${stats.checked}\n` +
                  `Conformes: ${stats.conform}\n` +
                  `Non conformes: ${stats.nonConform}\n` +
                  `N/A: ${stats.notApplicable}`);
        }

        function addDefect() {
            document.getElementById('defectModal').classList.remove('hidden');
            // Reset form
            document.getElementById('defectLocation').value = '';
            document.getElementById('defectEquipmentType').value = '';
            document.getElementById('defectType').innerHTML = '<option value="">-- S√©lectionner type √©quipement d\'abord --</option>';
            document.getElementById('defectCategory').value = 'MECHANICAL';
            selectedSeverity = null;
            document.querySelectorAll('.severity-btn').forEach(btn => {
                btn.classList.remove('bg-red-600', 'bg-orange-600', 'bg-yellow-600');
                btn.classList.add('bg-gray-700');
            });
            document.getElementById('defectUrgency').value = 'medium_term';
            document.getElementById('defectDescription').value = '';
            document.getElementById('defectImpact').value = '';
            document.getElementById('defectAction').value = '';
            document.getElementById('defectNormRef').value = '';
            document.querySelector('input[name="normViolation"][value="false"]').checked = true;
        }

        function closeDefectModal() {
            document.getElementById('defectModal').classList.add('hidden');
        }

        function selectSeverity(severity) {
            selectedSeverity = severity;
            // Reset all buttons
            document.querySelectorAll('.severity-btn').forEach(btn => {
                btn.classList.remove('bg-red-600', 'bg-orange-600', 'bg-yellow-600', 'border-green-400');
                btn.classList.add('bg-gray-700', 'border-gray-600');
            });
            // Highlight selected
            const btn = document.getElementById(`severity${severity.charAt(0).toUpperCase() + severity.slice(1)}`);
            btn.classList.remove('bg-gray-700', 'border-gray-600');
            btn.classList.add('border-green-400');
            if (severity === 'critical') btn.classList.add('bg-red-600');
            if (severity === 'major') btn.classList.add('bg-orange-600');
            if (severity === 'minor') btn.classList.add('bg-yellow-600');
        }

        const defectTypesByEquipment = {
            MODULE: [
                'MICROFISSURE - Fissures cellules',
                'DELAMINATION - D√©lamination couches',
                'SNAIL_TRAIL - Train√©es escargot',
                'HOT_SPOT - Point chaud',
                'PID - D√©gradation induite potentiel',
                'DISCOLORATION - D√©coloration',
                'BROKEN_GLASS - Verre cass√©',
                'FRAME_DAMAGE - Cadre endommag√©',
                'BYPASS_DIODE - Diode bypass d√©faillante',
                'CELL_DAMAGE - Cellule endommag√©e'
            ],
            STRUCTURE: [
                'CORROSION - Corrosion structure',
                'LOOSE_MOUNTING - Fixation desserr√©e',
                'DEFORMATION - D√©formation rails',
                'CRACK - Fissure structure',
                'MISSING_PART - Pi√®ce manquante',
                'IMPROPER_SPACING - √âcartement incorrect'
            ],
            CABLE: [
                'EXPOSED_CONDUCTOR - Conducteur expos√©',
                'INSULATION_DAMAGE - Isolation endommag√©e',
                'LOOSE_CONNECTION - Connexion desserr√©e',
                'UV_DAMAGE - D√©gradation UV',
                'RODENT_DAMAGE - D√©g√¢ts rongeurs',
                'IMPROPER_ROUTING - Cheminement incorrect'
            ],
            PROTECTION: [
                'FUSE_BLOWN - Fusible grill√©',
                'BREAKER_TRIPPED - Disjoncteur d√©clench√©',
                'MISSING_PROTECTION - Protection manquante',
                'INCORRECT_RATING - Calibre incorrect',
                'SURGE_DEVICE_FAILED - Parafoudre d√©faillant'
            ],
            CONNECTOR: [
                'MC4_NOT_LOCKED - MC4 non verrouill√©',
                'CORROSION - Corrosion connecteur',
                'CRACKED_HOUSING - Bo√Ætier fissur√©',
                'LOOSE_CONNECTION - Connexion desserr√©e',
                'WATER_INGRESS - Infiltration eau'
            ],
            JUNCTION_BOX: [
                'SEAL_FAILURE - √âtanch√©it√© d√©faillante',
                'CORROSION - Corrosion interne',
                'LOOSE_COVER - Couvercle desserr√©',
                'MISSING_GROMMET - Presse-√©toupe manquant',
                'BURN_MARKS - Traces br√ªlure'
            ],
            INVERTER: [
                'ERROR_CODE - Code erreur affich√©',
                'OVERHEATING - Surchauffe',
                'FAN_FAILURE - Ventilateur d√©faillant',
                'DISPLAY_ERROR - D√©faut affichage',
                'COMMUNICATION_LOSS - Perte communication',
                'GROUND_FAULT - D√©faut isolation'
            ],
            OTHER: [
                'CUSTOM - D√©faut personnalis√©'
            ]
        };

        function updateDefectTypes() {
            const equipmentType = document.getElementById('defectEquipmentType').value;
            const defectTypeSelect = document.getElementById('defectType');
            
            defectTypeSelect.innerHTML = '';
            
            if (!equipmentType) {
                defectTypeSelect.innerHTML = '<option value="">-- S√©lectionner type √©quipement d\'abord --</option>';
                return;
            }
            
            const types = defectTypesByEquipment[equipmentType] || [];
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type.split(' - ')[0];
                option.textContent = type;
                defectTypeSelect.appendChild(option);
            });
        }

        async function submitDefect() {
            // Validate required fields
            const location = document.getElementById('defectLocation').value.trim();
            const equipmentType = document.getElementById('defectEquipmentType').value;
            const defectType = document.getElementById('defectType').value;
            const description = document.getElementById('defectDescription').value.trim();
            
            if (!location || !equipmentType || !defectType || !description || !selectedSeverity) {
                alert('‚ö†Ô∏è Veuillez remplir tous les champs obligatoires:\n\n- Localisation\n- Type √©quipement\n- Type d√©faut\n- S√©v√©rit√© (cliquer sur un bouton)\n- Description');
                return;
            }

            try {
                const defectData = {
                    defectLocation: location,
                    equipmentType: equipmentType,
                    defectType: defectType,
                    defectCategory: document.getElementById('defectCategory').value,
                    severity: selectedSeverity,
                    urgency: document.getElementById('defectUrgency').value,
                    description: description,
                    potentialImpact: document.getElementById('defectImpact').value.trim() || null,
                    recommendedAction: document.getElementById('defectAction').value.trim() || null,
                    normReference: document.getElementById('defectNormRef').value.trim() || null,
                    normViolation: document.querySelector('input[name="normViolation"]:checked').value === 'true',
                    detectedBy: currentInspection.inspector_name || 'Inspector'
                };

                const response = await axios.post(
                    `/api/visual/inspection/${currentInspection.inspection_token}/defect`,
                    defectData
                );

                if (response.data.success) {
                    alert('‚úÖ D√©faut cr√©√© avec succ√®s !');
                    closeDefectModal();
                    // Reload inspection to update defect count
                    await loadInspection(currentInspection.inspection_token);
                } else {
                    alert('‚ùå Erreur lors de la cr√©ation du d√©faut');
                }
            } catch (error) {
                console.error('Error creating defect:', error);
                alert('‚ùå Erreur serveur lors de la cr√©ation du d√©faut');
            }
        }

        async function generateReport() {
            if (!currentInspection) {
                alert('‚ö†Ô∏è Aucune inspection charg√©e');
                return;
            }

            try {
                // Show loading
                const originalText = event.target.innerHTML;
                event.target.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>G√âN√âRATION...';
                event.target.disabled = true;

                // Reload inspection to get latest data including defects
                const response = await axios.get(`/api/visual/inspection/${currentInspection.inspection_token}`);
                const data = response.data;

                // Initialize jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPos = 20;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;

                // Helper function to check if we need a new page
                function checkNewPage(requiredSpace = 20) {
                    if (yPos + requiredSpace > pageHeight - margin) {
                        doc.addPage();
                        yPos = margin;
                        return true;
                    }
                    return false;
                }

                // PAGE 1: PAGE DE GARDE
                doc.setFontSize(24);
                doc.setTextColor(34, 197, 94); // Green
                doc.text('RAPPORT DE CONTR√îLE VISUEL', 105, yPos, { align: 'center' });
                
                yPos += 10;
                doc.setFontSize(16);
                doc.setTextColor(100, 100, 100);
                doc.text('IEC 62446-1 : Inspection Syst√®me Photovolta√Øque', 105, yPos, { align: 'center' });
                
                yPos += 20;
                doc.setDrawColor(34, 197, 94);
                doc.setLineWidth(0.5);
                doc.line(margin, yPos, 190, yPos);
                
                yPos += 15;
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'bold');
                doc.text('INFORMATIONS INSPECTION', margin, yPos);
                
                yPos += 8;
                doc.setFont(undefined, 'normal');
                doc.text(`Projet : ${data.inspection.project_name}`, margin, yPos);
                yPos += 6;
                doc.text(`Client : ${data.inspection.client_name}`, margin, yPos);
                yPos += 6;
                doc.text(`Site : ${data.inspection.location}`, margin, yPos);
                yPos += 6;
                doc.text(`Date inspection : ${data.inspection.inspection_date}`, margin, yPos);
                yPos += 6;
                doc.text(`Inspecteur : ${data.inspection.inspector_name || 'N/A'}`, margin, yPos);
                yPos += 6;
                doc.text(`Token inspection : ${data.inspection.inspection_token}`, margin, yPos);
                
                yPos += 15;
                doc.setFont(undefined, 'bold');
                doc.text('SYNTH√àSE GLOBALE', margin, yPos);
                
                yPos += 8;
                doc.setFont(undefined, 'normal');
                doc.text(`Total items checklist : ${data.stats.totalItems}`, margin, yPos);
                yPos += 6;
                doc.text(`Items v√©rifi√©s : ${data.stats.checkedItems} (${Math.round(data.stats.checkedItems / data.stats.totalItems * 100)}%)`, margin, yPos);
                yPos += 6;
                doc.setTextColor(34, 197, 94);
                doc.text(`Items conformes : ${data.stats.totalItems - data.stats.nonConformItems}`, margin, yPos);
                yPos += 6;
                doc.setTextColor(239, 68, 68);
                doc.text(`Items non-conformes : ${data.stats.nonConformItems}`, margin, yPos);
                yPos += 6;
                doc.setTextColor(0, 0, 0);
                doc.text(`D√©fauts critiques identifi√©s : ${data.stats.criticalDefects}`, margin, yPos);
                
                // PAGE 2+: CHECKLIST D√âTAILL√âE
                doc.addPage();
                yPos = margin;
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('CHECKLIST IEC 62446-1 D√âTAILL√âE', margin, yPos);
                
                yPos += 10;
                doc.setFontSize(10);
                
                const categories = ['MECHANICAL', 'ELECTRICAL', 'DOCUMENTATION', 'SAFETY'];
                const categoryLabels = {
                    MECHANICAL: 'M√âCANIQUE',
                    ELECTRICAL: '√âLECTRIQUE',
                    DOCUMENTATION: 'DOCUMENTATION',
                    SAFETY: 'S√âCURIT√â'
                };
                
                for (const category of categories) {
                    checkNewPage(15);
                    
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(12);
                    doc.setTextColor(34, 197, 94);
                    doc.text(`${categoryLabels[category]}`, margin, yPos);
                    yPos += 7;
                    doc.setFontSize(10);
                    
                    const categoryItems = data.items.filter(item => item.category === category);
                    
                    for (const item of categoryItems) {
                        checkNewPage(25);
                        
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(0, 0, 0);
                        doc.text(`${item.item_code} - ${item.item_description.substring(0, 70)}`, margin, yPos);
                        yPos += 5;
                        
                        doc.setFont(undefined, 'normal');
                        
                        // Status
                        if (item.conformity === 'conform') {
                            doc.setTextColor(34, 197, 94);
                            doc.text('‚úì CONFORME', margin + 5, yPos);
                        } else if (item.conformity === 'non_conform') {
                            doc.setTextColor(239, 68, 68);
                            doc.text('‚úó NON CONFORME', margin + 5, yPos);
                        } else if (item.conformity === 'not_applicable') {
                            doc.setTextColor(156, 163, 175);
                            doc.text('N/A', margin + 5, yPos);
                        } else {
                            doc.setTextColor(156, 163, 175);
                            doc.text('EN ATTENTE', margin + 5, yPos);
                        }
                        yPos += 5;
                        
                        doc.setTextColor(0, 0, 0);
                        if (item.observation) {
                            const obsLines = doc.splitTextToSize(`Observation: ${item.observation}`, 170);
                            doc.text(obsLines, margin + 5, yPos);
                            yPos += obsLines.length * 5;
                        }
                        
                        yPos += 3;
                    }
                    
                    yPos += 5;
                }
                
                // PAGE N: D√âFAUTS IDENTIFI√âS
                if (data.defects && data.defects.length > 0) {
                    doc.addPage();
                    yPos = margin;
                    
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(239, 68, 68);
                    doc.text('D√âFAUTS IDENTIFI√âS', margin, yPos);
                    
                    yPos += 10;
                    doc.setFontSize(10);
                    
                    for (let i = 0; i < data.defects.length; i++) {
                        const defect = data.defects[i];
                        checkNewPage(35);
                        
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(0, 0, 0);
                        doc.text(`D√âFAUT #${i + 1}`, margin, yPos);
                        yPos += 7;
                        
                        doc.setFont(undefined, 'normal');
                        doc.text(`Localisation: ${defect.defect_location}`, margin + 5, yPos);
                        yPos += 5;
                        doc.text(`Type: ${defect.defect_type} (${defect.equipment_type})`, margin + 5, yPos);
                        yPos += 5;
                        
                        // Severity color
                        if (defect.severity === 'critical') doc.setTextColor(239, 68, 68);
                        else if (defect.severity === 'major') doc.setTextColor(249, 115, 22);
                        else doc.setTextColor(234, 179, 8);
                        doc.text(`S√©v√©rit√©: ${defect.severity.toUpperCase()}`, margin + 5, yPos);
                        yPos += 5;
                        doc.setTextColor(0, 0, 0);
                        
                        doc.text(`Urgence: ${defect.urgency}`, margin + 5, yPos);
                        yPos += 5;
                        
                        if (defect.description) {
                            const descLines = doc.splitTextToSize(`Description: ${defect.description}`, 165);
                            doc.text(descLines, margin + 5, yPos);
                            yPos += descLines.length * 5;
                        }
                        
                        if (defect.recommended_action) {
                            const actionLines = doc.splitTextToSize(`Action: ${defect.recommended_action}`, 165);
                            doc.text(actionLines, margin + 5, yPos);
                            yPos += actionLines.length * 5;
                        }
                        
                        yPos += 5;
                    }
                }
                
                // DERNI√àRE PAGE: FOOTER DIAGPV
                doc.addPage();
                yPos = margin;
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(34, 197, 94);
                doc.text('Diagnostic Photovolta√Øque', 105, yPos, { align: 'center' });
                
                yPos += 8;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                doc.text('Expertise ind√©pendante depuis 2012', 105, yPos, { align: 'center' });
                yPos += 6;
                doc.text('3 rue d\'Apollo, 31240 L\'Union', 105, yPos, { align: 'center' });
                yPos += 5;
                doc.text('üìû 05.81.10.16.59 | üìß contact@diagpv.fr', 105, yPos, { align: 'center' });
                yPos += 5;
                doc.text('üåê www.diagnosticphotovoltaique.fr', 105, yPos, { align: 'center' });
                yPos += 5;
                doc.text('RCS 792972309', 105, yPos, { align: 'center' });
                
                yPos += 15;
                doc.setTextColor(100, 100, 100);
                doc.setFontSize(8);
                doc.text('Ce rapport est conforme √† la norme IEC 62446-1 pour l\'inspection des syst√®mes photovolta√Øques.', 105, yPos, { align: 'center' });
                yPos += 4;
                doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}`, 105, yPos, { align: 'center' });
                
                // Save PDF
                const filename = `DiagPV_Rapport_Visual_${data.inspection.inspection_token}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                
                alert('‚úÖ Rapport PDF g√©n√©r√© avec succ√®s !');
                
                // Restore button
                event.target.innerHTML = originalText;
                event.target.disabled = false;
                
            } catch (error) {
                console.error('Error generating report:', error);
                alert('‚ùå Erreur lors de la g√©n√©ration du rapport PDF');
                // Restore button
                event.target.innerHTML = '<i class="fas fa-file-pdf mr-1"></i><span class="hidden sm:inline">RAPPORT</span>';
                event.target.disabled = false;
            }
        }

        function showMenu() {
            const menu = confirm('MENU\n\nVoulez-vous quitter cette inspection ?');
            if (menu) {
                window.location.href = '/static/visual-inspection.html';
            }
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').classList.remove('hidden');
        }

        // Helper functions
        function getItemBorderColor(item) {
            if (item.conformity === 'conform') return 'border-green-500';
            if (item.conformity === 'non_conform') return 'border-red-500';
            if (item.status === 'checked') return 'border-yellow-500';
            return 'border-gray-600';
        }

        function getItemBgColor(item) {
            if (item.conformity === 'conform') return 'bg-green-600';
            if (item.conformity === 'non_conform') return 'bg-red-600';
            return 'bg-gray-700';
        }

        function getCategoryColor(category) {
            const colors = {
                MECHANICAL: 'bg-blue-600',
                ELECTRICAL: 'bg-yellow-600',
                DOCUMENTATION: 'bg-purple-600',
                SAFETY: 'bg-orange-600'
            };
            return colors[category] || 'bg-gray-600';
        }

        function getCategoryLabel(category) {
            const labels = {
                MECHANICAL: 'M√âCA',
                ELECTRICAL: '√âLEC',
                DOCUMENTATION: 'DOC',
                SAFETY: 'S√âCU'
            };
            return labels[category] || category;
        }

        function getConformityLabel(conformity) {
            const labels = {
                pending: 'En attente',
                conform: '‚úì Conforme',
                non_conform: '‚úó Non conforme',
                not_applicable: 'N/A'
            };
            return labels[conformity] || conformity;
        }
    </script>
</body>
</html>
