
// Auto-generated file. Do not edit manually.
export const unifiedEditorHtml = "<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Digital Twin Studio - DiagPV</title>\n    <script src=\"https://cdn.tailwindcss.com\"></script>\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\">\n    <!-- Leaflet CSS -->\n    <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.4/dist/leaflet.css\" />\n    <style>\n        body, html { height: 100%; overflow: hidden; }\n        .canvas-grid {\n            background-image: \n                linear-gradient(#e5e7eb 1px, transparent 1px),\n                linear-gradient(90deg, #e5e7eb 1px, transparent 1px);\n            background-size: 20px 20px;\n        }\n        .inspector-panel {\n            transition: transform 0.3s ease-in-out;\n        }\n        .inspector-panel.closed {\n            transform: translateX(100%);\n        }\n    </style>\n</head>\n<body class=\"bg-gray-100 flex flex-col h-full text-slate-800\">\n\n    <!-- 1. TOP BAR (Command Center) -->\n    <header class=\"bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 z-20 shadow-sm\">\n        <div class=\"flex items-center space-x-4\">\n            <button onclick=\"history.back()\" class=\"text-gray-500 hover:text-gray-800\">\n                <i class=\"fas fa-arrow-left\"></i>\n            </button>\n            <div>\n                <h1 class=\"text-lg font-bold text-gray-800\">Digital Twin Studio</h1>\n                <div class=\"flex items-center text-xs text-gray-500 space-x-2\">\n                    <span id=\"plantName\">Centrale Inconnue</span>\n                    <i class=\"fas fa-chevron-right text-[10px]\"></i>\n                    <select id=\"missionSelector\" onchange=\"updateMissionContext()\" class=\"bg-transparent border-none font-bold text-purple-700 focus:ring-0 cursor-pointer\">\n                        <option value=\"all\">Mission Compl\u00e8te (EL + IV + Visuel)</option>\n                        <option value=\"el\">Audit \u00c9lectroluminescence</option>\n                        <option value=\"visual\">Audit Visuel / Drone</option>\n                        <option value=\"iv\">Audit Courbes I-V</option>\n                    </select>\n                </div>\n            </div>\n        </div>\n\n        <!-- View Switcher -->\n        <div class=\"flex bg-gray-100 p-1 rounded-lg\">\n            <button onclick=\"switchView('map')\" id=\"btnViewMap\" class=\"px-4 py-1.5 rounded-md text-sm font-medium transition-colors bg-white shadow-sm text-purple-700\">\n                <i class=\"fas fa-satellite mr-2\"></i>Satellite\n            </button>\n            <button onclick=\"switchView('schematic')\" id=\"btnViewSchematic\" class=\"px-4 py-1.5 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900\">\n                <i class=\"fas fa-project-diagram mr-2\"></i>Sch\u00e9matique\n            </button>\n        </div>\n\n        <div class=\"flex items-center space-x-3\">\n            <button id=\"btnAutoPlace\" onclick=\"autoPlaceModules()\" class=\"hidden bg-yellow-500 text-white hover:bg-yellow-600 px-3 py-2 rounded-lg text-sm font-bold shadow-md transition-colors animate-pulse\">\n                <i class=\"fas fa-magic mr-2\"></i>Placer Modules\n            </button>\n            <div id=\"syncStatus\" class=\"text-xs text-gray-400 hidden\">\n                <i class=\"fas fa-check mr-1\"></i>Sauvegard\u00e9\n            </div>\n            <button onclick=\"syncFull()\" class=\"bg-purple-100 text-purple-700 hover:bg-purple-200 px-3 py-2 rounded-lg text-sm font-semibold transition-colors\">\n                <i class=\"fas fa-sync-alt mr-2\"></i>Sync Multi-Modules\n            </button>\n            <button onclick=\"saveChanges()\" class=\"bg-purple-600 text-white hover:bg-purple-700 px-4 py-2 rounded-lg text-sm font-bold shadow-md transition-colors\">\n                <i class=\"fas fa-save mr-2\"></i>Sauvegarder\n            </button>\n        </div>\n    </header>\n\n    <!-- 2. MAIN WORKSPACE -->\n    <div class=\"flex-1 flex overflow-hidden relative\">\n        \n        <!-- LEFT: Module List (Collapsible) -->\n        <div class=\"w-64 bg-white border-r border-gray-200 flex flex-col z-10\">\n            <div class=\"p-4 border-b border-gray-100\">\n                <input type=\"text\" placeholder=\"Rechercher module...\" class=\"w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-md text-sm focus:outline-none focus:border-purple-500\">\n            </div>\n            \n            <!-- Alert for unplaced modules -->\n            <div id=\"unplacedAlert\" class=\"hidden bg-yellow-50 border-b border-yellow-100 p-2 text-xs text-yellow-800 flex items-center justify-between\">\n                <span>\u26a0\ufe0f <span id=\"unplacedCount\">0</span> modules sans GPS</span>\n                <button onclick=\"autoPlaceModules()\" class=\"underline font-bold\">Placer</button>\n            </div>\n\n            <div class=\"flex-1 overflow-y-auto p-2 space-y-1\" id=\"moduleList\">\n                <!-- Modules injected here -->\n            </div>\n            <div class=\"p-3 border-t border-gray-100 bg-gray-50 text-xs text-center text-gray-400\">\n                <span id=\"totalModules\">0</span> modules \u2022 <span id=\"totalStrings\">0</span> strings\n            </div>\n        </div>\n\n        <!-- CENTER: Canvas / Map -->\n        <div class=\"flex-1 relative bg-gray-50\">\n            \n            <!-- Map View -->\n            <div id=\"mapContainer\" class=\"absolute inset-0 z-0\"></div>\n\n            <!-- Schematic View (Hidden by default) -->\n            <div id=\"schematicContainer\" class=\"absolute inset-0 z-0 hidden canvas-grid overflow-hidden\">\n                <canvas id=\"schematicCanvas\"></canvas>\n            </div>\n\n            <!-- Loading Overlay -->\n            <div id=\"loadingOverlay\" class=\"absolute inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center\">\n                <div class=\"text-center\">\n                    <div class=\"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4\"></div>\n                    <p class=\"text-gray-500 font-medium\">Chargement du Jumeau Num\u00e9rique...</p>\n                </div>\n            </div>\n        </div>\n\n        <!-- RIGHT: INSPECTOR (The \"Lateral Inspector\") -->\n        <div id=\"inspectorPanel\" class=\"w-80 bg-white border-l border-gray-200 shadow-xl z-20 flex flex-col inspector-panel closed absolute right-0 top-0 bottom-0 h-full\">\n            <!-- Header -->\n            <div class=\"h-16 border-b border-gray-200 flex items-center justify-between px-6 bg-gray-50\">\n                <div>\n                    <h2 class=\"font-bold text-lg text-gray-800\" id=\"inspModuleId\">--</h2>\n                    <p class=\"text-xs text-gray-500\" id=\"inspStringId\">S\u00e9lectionnez un module</p>\n                </div>\n                <button onclick=\"closeInspector()\" class=\"text-gray-400 hover:text-gray-600\">\n                    <i class=\"fas fa-times\"></i>\n                </button>\n            </div>\n\n            <!-- Tabs -->\n            <div class=\"flex border-b border-gray-200\">\n                <button onclick=\"switchTab('el')\" class=\"flex-1 py-3 text-sm font-medium text-purple-600 border-b-2 border-purple-600 active-tab\">EL</button>\n                <button onclick=\"switchTab('visual')\" class=\"flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700\">Visuel</button>\n                <button onclick=\"switchTab('iv')\" class=\"flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700\">I-V</button>\n                <button onclick=\"switchTab('info')\" class=\"flex-1 py-3 text-sm font-medium text-gray-500 hover:text-gray-700\">Infos</button>\n            </div>\n\n            <!-- Content -->\n            <div class=\"flex-1 overflow-y-auto p-6 space-y-6\">\n                \n                <!-- TAB: EL Audit -->\n                <div id=\"tab-el\" class=\"space-y-4\">\n                    <div class=\"aspect-square bg-gray-900 rounded-lg overflow-hidden relative group\">\n                        <img id=\"inspELImage\" src=\"\" class=\"w-full h-full object-contain hidden\">\n                        <div id=\"inspELPlaceholder\" class=\"w-full h-full flex items-center justify-center text-gray-500 flex-col\">\n                            <i class=\"fas fa-camera-retro text-3xl mb-2\"></i>\n                            <span class=\"text-xs\">Pas d'image EL</span>\n                        </div>\n                        <div class=\"absolute bottom-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded\">\n                            EL\n                        </div>\n                    </div>\n\n                    <div>\n                        <label class=\"block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2\">Statut \u00c9lectroluminescence</label>\n                        <select id=\"inspELStatus\" onchange=\"updateModuleStatus('el')\" class=\"w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent\">\n                            <option value=\"ok\">\ud83d\udfe2 OK (Intact)</option>\n                            <option value=\"microcracks\">\ud83d\udfe0 Microfissures</option>\n                            <option value=\"pid\">\ud83d\udfe0 PID (D\u00e9gradation)</option>\n                            <option value=\"dead_cell\">\ud83d\udd34 Cellule Morte</option>\n                            <option value=\"hotspot\">\ud83d\udd34 Hotspot</option>\n                            <option value=\"bypass_diode\">\ud83d\udd34 Diode Bypass</option>\n                            <option value=\"string_open\">\u26ab String Ouvert</option>\n                        </select>\n                    </div>\n                </div>\n\n                <!-- TAB: Visual -->\n                <div id=\"tab-visual\" class=\"space-y-4 hidden\">\n                    <div>\n                        <label class=\"block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2\">\u00c9tat Visuel</label>\n                        <select id=\"inspVisualStatus\" onchange=\"updateModuleStatus('visual')\" class=\"w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-md\">\n                            <option value=\"ok\">\ud83d\udfe2 RAS</option>\n                            <option value=\"dirty\">\ud83d\udfe0 Sale / Soiling</option>\n                            <option value=\"vegetation\">\ud83d\udfe0 Ombrage V\u00e9g\u00e9tation</option>\n                            <option value=\"breakage\">\ud83d\udd34 Casse / Impact</option>\n                            <option value=\"delamination\">\ud83d\udd34 D\u00e9lamination</option>\n                        </select>\n                    </div>\n                </div>\n\n                <!-- TAB: IV -->\n                 <div id=\"tab-iv\" class=\"space-y-4 hidden\">\n                    <div class=\"p-4 bg-blue-50 rounded-lg border border-blue-200\">\n                        <h3 class=\"font-bold text-blue-800 text-sm mb-1\"><i class=\"fas fa-bolt mr-2\"></i>Audit I-V</h3>\n                        <p class=\"text-xs text-blue-700\">Mesures \u00e9lectriques.</p>\n                    </div>\n                     <div>\n                        <label class=\"block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2\">\u00c9tat I-V</label>\n                        <select id=\"inspIVStatus\" onchange=\"updateModuleStatus('iv')\" class=\"w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-md\">\n                            <option value=\"ok\">\ud83d\udfe2 Normal</option>\n                            <option value=\"measured\">\ud83d\udd35 Mesur\u00e9</option>\n                            <option value=\"low_power\">\ud83d\udfe0 Sous-performance</option>\n                        </select>\n                    </div>\n                </div>\n\n                <!-- TAB: Infos -->\n                <div id=\"tab-info\" class=\"space-y-4 hidden\">\n                    <div class=\"grid grid-cols-2 gap-4\">\n                        <div>\n                            <label class=\"text-xs text-gray-400\">Latitude</label>\n                            <div class=\"font-mono text-sm\" id=\"inspLat\">-</div>\n                        </div>\n                        <div>\n                            <label class=\"text-xs text-gray-400\">Longitude</label>\n                            <div class=\"font-mono text-sm\" id=\"inspLon\">-</div>\n                        </div>\n                        <div>\n                            <label class=\"text-xs text-gray-400\">String</label>\n                            <input type=\"number\" id=\"inspStringInput\" class=\"w-full border rounded px-2 py-1 text-sm\">\n                        </div>\n                        <div>\n                            <label class=\"text-xs text-gray-400\">Position</label>\n                            <input type=\"number\" id=\"inspPosInput\" class=\"w-full border rounded px-2 py-1 text-sm\">\n                        </div>\n                    </div>\n                </div>\n\n            </div>\n            \n            <!-- Footer -->\n            <div class=\"p-4 border-t border-gray-200 bg-gray-50\">\n                <button onclick=\"saveInspector()\" class=\"w-full bg-purple-600 text-white py-2 rounded-md font-semibold hover:bg-purple-700 transition\">\n                    Appliquer les modifications\n                </button>\n            </div>\n        </div>\n\n    </div>\n\n    <!-- Scripts -->\n    <script src=\"https://unpkg.com/leaflet@1.9.4/dist/leaflet.js\"></script>\n    <script>\n        // --- GLOBAL STATE ---\n        const ZONE_ID = window.location.pathname.split('/').pop();\n        let MODULES = []; // The Single Source of Truth\n        let VIEW_MODE = 'map'; // 'map' or 'schematic'\n        let SELECTED_MODULE_ID = null;\n        let map = null;\n        let mapMarkers = {}; // id -> L.rectangle\n        \n        // --- INITIALIZATION ---\n        document.addEventListener('DOMContentLoaded', async () => {\n            await initMap();\n            await loadTopology();\n        });\n\n        // --- API CALLS ---\n        async function loadTopology() {\n            document.getElementById('loadingOverlay').classList.remove('hidden');\n            try {\n                const res = await fetch(`/api/unified/topology/${ZONE_ID}`);\n                const data = await res.json();\n                if(data.success) {\n                    MODULES = data.modules;\n                    renderModuleList();\n                    renderMapModules();\n                    // renderSchematicModules(); // TODO\n                    updateStats();\n                    checkUnplacedModules();\n                } else {\n                    alert('Erreur chargement: ' + data.error);\n                }\n            } catch(e) {\n                console.error(e);\n                alert('Erreur r\u00e9seau');\n            } finally {\n                document.getElementById('loadingOverlay').classList.add('hidden');\n            }\n        }\n\n        function checkUnplacedModules() {\n            const unplaced = MODULES.filter(m => !m.geo_lat || !m.geo_lon);\n            const count = unplaced.length;\n            document.getElementById('unplacedCount').innerText = count;\n            \n            if(count > 0) {\n                document.getElementById('unplacedAlert').classList.remove('hidden');\n                document.getElementById('btnAutoPlace').classList.remove('hidden');\n            } else {\n                document.getElementById('unplacedAlert').classList.add('hidden');\n                document.getElementById('btnAutoPlace').classList.add('hidden');\n            }\n        }\n\n        async function syncFull() {\n            if(!confirm(\"Lancer la synchronisation multi-modules (EL + Visual + IV) ?\")) return;\n            \n            try {\n                const res = await fetch(`/api/unified/topology/${ZONE_ID}/sync-full`, { method: 'POST' });\n                const data = await res.json();\n                if(data.success) {\n                    alert(`${data.total_synced_topology} modules synchronis\u00e9s !\\nLogs:\\n${data.logs.join('\\n')}`);\n                    loadTopology(); // Reload data\n                } else {\n                    alert('Erreur sync: ' + data.error);\n                }\n            } catch(e) {\n                alert('Erreur r\u00e9seau pendant la sync');\n            }\n        }\n\n        // --- MAP ENGINE (Leaflet) ---\n        async function initMap() {\n            map = L.map('mapContainer').setView([43.6, 1.4], 18); // Default Toulouse\n            \n            // Google Satellite Layer\n            L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{\n                maxZoom: 21,\n                subdomains:['mt0','mt1','mt2','mt3']\n            }).addTo(map);\n\n            // Add center marker for reference\n            // L.marker(map.getCenter()).addTo(map).bindPopup('Centre de la zone');\n        }\n\n        function renderMapModules() {\n            // Clear existing\n            Object.values(mapMarkers).forEach(m => map.removeLayer(m));\n            mapMarkers = {};\n            \n            if(MODULES.length === 0) return;\n\n            const bounds = L.latLngBounds([]);\n            let hasBounds = false;\n\n            MODULES.forEach(m => {\n                if(!m.geo_lat || !m.geo_lon) return; // Skip if no GPS\n\n                const color = getStatusColor(m);\n                // Module size approx: 1m x 1.6m -> ~0.00001 deg\n                const width = 0.000015; \n                const height = 0.00001;\n                \n                const boundsArr = [\n                    [m.geo_lat, m.geo_lon], \n                    [m.geo_lat + height, m.geo_lon + width] \n                ];\n\n                const rect = L.rectangle(boundsArr, {\n                    color: color,\n                    weight: 1,\n                    fillOpacity: 0.6,\n                    draggable: true // Not native in L.rectangle without plugin?\n                }).addTo(map);\n                \n                // Add simple popup/tooltip\n                rect.bindTooltip(`S${m.string_number}:P${m.position_in_string}`, { permanent: false, direction: 'center' });\n\n                // Make draggable (Manual implementation for Leaflet Rects)\n                enableDrag(rect, m);\n\n                rect.on('click', () => openInspector(m.id));\n                mapMarkers[m.id] = rect;\n                bounds.extend(boundsArr);\n                hasBounds = true;\n            });\n\n            if(hasBounds) map.fitBounds(bounds);\n        }\n\n        // Leaflet Rectangle Dragging Logic (simplified)\n        function enableDrag(rect, module) {\n            let startPoint = null;\n            let startBounds = null;\n\n            rect.on('mousedown', function(e) {\n                map.dragging.disable();\n                startPoint = e.latlng;\n                startBounds = rect.getBounds();\n                L.DomEvent.stopPropagation(e);\n            });\n\n            map.on('mousemove', function(e) {\n                if(startPoint) {\n                    const latDiff = e.latlng.lat - startPoint.lat;\n                    const lngDiff = e.latlng.lng - startPoint.lng;\n                    \n                    const newSouthWest = L.latLng(startBounds.getSouthWest().lat + latDiff, startBounds.getSouthWest().lng + lngDiff);\n                    const newNorthEast = L.latLng(startBounds.getNorthEast().lat + latDiff, startBounds.getNorthEast().lng + lngDiff);\n                    \n                    rect.setBounds(L.latLngBounds(newSouthWest, newNorthEast));\n                }\n            });\n\n            map.on('mouseup', function(e) {\n                if(startPoint) {\n                    map.dragging.enable();\n                    \n                    // Update Module Data\n                    const center = rect.getBounds().getSouthWest(); // Use SW as origin for simplicity\n                    module.geo_lat = center.lat;\n                    module.geo_lon = center.lng;\n                    module._dirty = true; // Mark as modified\n                    \n                    // Show \"Unsaved\" indicator\n                    document.getElementById('syncStatus').innerText = 'Modifications non sauvegard\u00e9es';\n                    document.getElementById('syncStatus').classList.remove('text-gray-400', 'hidden');\n                    document.getElementById('syncStatus').classList.add('text-orange-500');\n\n                    startPoint = null;\n                }\n            });\n        }\n\n        // --- AUTO PLACE LOGIC ---\n        function autoPlaceModules() {\n            if(!confirm(\"Placer automatiquement les modules sans GPS au centre de l'\u00e9cran ?\")) return;\n\n            const center = map.getCenter();\n            const startLat = center.lat;\n            const startLon = center.lng;\n            const gap = 0.00002; // Gap between modules\n\n            let currentRow = 0;\n            let currentCol = 0;\n            const maxCols = 20; // Break line every 20 modules\n\n            MODULES.forEach(m => {\n                if(!m.geo_lat || !m.geo_lon) {\n                    m.geo_lat = startLat - (currentRow * gap * 1.5); // Rows go down\n                    m.geo_lon = startLon + (currentCol * gap); // Cols go right\n                    m._dirty = true;\n\n                    currentCol++;\n                    if(currentCol >= maxCols) {\n                        currentCol = 0;\n                        currentRow++;\n                    }\n                }\n            });\n\n            renderMapModules();\n            checkUnplacedModules();\n            alert(\"Modules plac\u00e9s ! Vous pouvez maintenant les d\u00e9placer. N'oubliez pas de sauvegarder.\");\n        }\n\n        // --- SAVE LOGIC ---\n        async function saveChanges() {\n            const modified = MODULES.filter(m => m._dirty);\n            if(modified.length === 0) {\n                alert(\"Aucune modification \u00e0 sauvegarder.\");\n                return;\n            }\n\n            try {\n                const res = await fetch(`/api/unified/topology/${ZONE_ID}/save`, {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify({ modules: modified })\n                });\n                \n                const data = await res.json();\n                if(data.success) {\n                    alert('Sauvegarde r\u00e9ussie !');\n                    // Reset dirty flags\n                    modified.forEach(m => delete m._dirty);\n                    document.getElementById('syncStatus').innerText = 'Sauvegard\u00e9';\n                    document.getElementById('syncStatus').classList.add('text-gray-400');\n                    document.getElementById('syncStatus').classList.remove('text-orange-500', 'hidden');\n                } else {\n                    alert('Erreur sauvegarde: ' + data.error);\n                }\n            } catch(e) {\n                alert('Erreur r\u00e9seau lors de la sauvegarde');\n            }\n        }\n\n        // --- UI LOGIC ---\n        function getStatusColor(m) {\n            // CORRELATION ENGINE (Simple Version)\n            // Priority: Red (Critical) > Orange (Warning) > Green (OK) > Gray (Unknown)\n            \n            const defects = [];\n            if(m.status_el && m.status_el !== 'ok') defects.push({ type: 'el', val: m.status_el });\n            if(m.status_visual && m.status_visual !== 'ok') defects.push({ type: 'vis', val: m.status_visual });\n            if(m.status_iv && m.status_iv !== 'ok') defects.push({ type: 'iv', val: m.status_iv });\n\n            // 1. Critical\n            if(defects.some(d => ['dead_cell', 'hotspot', 'bypass_diode', 'breakage', 'delamination', 'string_open'].includes(d.val))) {\n                return '#ef4444'; // Red\n            }\n            // 2. Warning\n            if(defects.some(d => ['microcracks', 'pid', 'dirty', 'vegetation', 'low_power'].includes(d.val))) {\n                return '#f97316'; // Orange\n            }\n            // 3. Info / Measured\n            if(defects.some(d => ['measured'].includes(d.val))) {\n                return '#3b82f6'; // Blue\n            }\n            // 4. OK\n            if(m.status_el === 'ok' || m.status_visual === 'ok' || m.status_iv === 'ok') {\n                return '#22c55e'; // Green\n            }\n\n            return '#94a3b8'; // Gray\n        }\n\n        function updateMissionContext() {\n            const mission = document.getElementById('missionSelector').value;\n            // Filter Tabs\n            const tabs = {\n                'el': document.querySelector('button[onclick=\"switchTab(\\\\'el\\\\')\"]'),\n                'visual': document.querySelector('button[onclick=\"switchTab(\\\\'visual\\\\')\"]'),\n                'iv': document.querySelector('button[onclick=\"switchTab(\\\\'iv\\\\')\"]'),\n            };\n            \n            // Reset all\n            Object.values(tabs).forEach(t => t.style.display = 'block');\n\n            if(mission === 'el') {\n                tabs['visual'].style.display = 'none';\n                tabs['iv'].style.display = 'none';\n                switchTab('el');\n            } else if (mission === 'visual') {\n                tabs['el'].style.display = 'none';\n                tabs['iv'].style.display = 'none';\n                switchTab('visual');\n            } else if (mission === 'iv') {\n                tabs['el'].style.display = 'none';\n                tabs['visual'].style.display = 'none';\n                switchTab('iv');\n            }\n            \n            // Re-render map to reflect context if we want mission-specific coloring (optional)\n            // For now, we keep correlation view as default\n        }\n\n        function renderModuleList() {\n            const list = document.getElementById('moduleList');\n            list.innerHTML = '';\n            \n            MODULES.sort((a,b) => {\n                if(a.string_number !== b.string_number) return a.string_number - b.string_number;\n                return a.position_in_string - b.position_in_string;\n            });\n\n            MODULES.forEach(m => {\n                const el = document.createElement('div');\n                el.className = 'flex items-center p-2 hover:bg-purple-50 cursor-pointer rounded text-xs';\n                el.onclick = () => openInspector(m.id);\n                \n                // Indicateur si non plac\u00e9\n                const unplaced = (!m.geo_lat || !m.geo_lon) ? '<span title=\"Non plac\u00e9 sur carte\">\ud83d\udccd\u2753</span>' : '';\n\n                el.innerHTML = `\n                    <div class=\"w-3 h-3 rounded-full mr-2\" style=\"background-color: ${getStatusColor(m)}\"></div>\n                    <span class=\"font-mono font-bold w-16\">${m.module_identifier}</span>\n                    <span class=\"text-gray-400 mr-2\">S${m.string_number}:P${m.position_in_string}</span>\n                    ${unplaced}\n                `;\n                list.appendChild(el);\n            });\n        }\n\n        function updateStats() {\n            document.getElementById('totalModules').innerText = MODULES.length;\n            const strings = new Set(MODULES.map(m => m.string_number));\n            document.getElementById('totalStrings').innerText = strings.size;\n        }\n\n        // --- INSPECTOR LOGIC ---\n        function openInspector(moduleId) {\n            const m = MODULES.find(mod => mod.id === moduleId);\n            if(!m) return;\n            SELECTED_MODULE_ID = moduleId;\n\n            document.getElementById('inspectorPanel').classList.remove('closed');\n            \n            // Populate Data\n            document.getElementById('inspModuleId').innerText = m.module_identifier;\n            document.getElementById('inspStringId').innerText = `String ${m.string_number} \u2022 Pos ${m.position_in_string}`;\n            \n            // EL Tab\n            document.getElementById('inspELStatus').value = m.status_el || 'ok';\n            if(m.el_image_url) {\n                document.getElementById('inspELImage').src = m.el_image_url;\n                document.getElementById('inspELImage').classList.remove('hidden');\n                document.getElementById('inspELPlaceholder').classList.add('hidden');\n            } else {\n                document.getElementById('inspELImage').classList.add('hidden');\n                document.getElementById('inspELPlaceholder').classList.remove('hidden');\n            }\n\n            // Info Tab\n            document.getElementById('inspLat').innerText = m.geo_lat?.toFixed(6) || '-';\n            document.getElementById('inspLon').innerText = m.geo_lon?.toFixed(6) || '-';\n            document.getElementById('inspStringInput').value = m.string_number;\n            document.getElementById('inspPosInput').value = m.position_in_string;\n\n            // Visual Tab\n            document.getElementById('inspVisualStatus').value = m.status_visual || 'ok';\n            \n            // IV Tab\n            document.getElementById('inspIVStatus').value = m.status_iv || 'ok';\n\n            // Highlight in List\n            // TODO\n        }\n\n        function closeInspector() {\n            document.getElementById('inspectorPanel').classList.add('closed');\n            SELECTED_MODULE_ID = null;\n        }\n\n        function switchTab(tab) {\n            // Hide all contents\n            ['el', 'visual', 'iv', 'info'].forEach(t => {\n                document.getElementById(`tab-${t}`).classList.add('hidden');\n            });\n            // Show selected\n            document.getElementById(`tab-${tab}`).classList.remove('hidden');\n            \n            // Update buttons style (simple version)\n            // In real app, toggle classes\n        }\n\n        function updateModuleStatus(type) {\n            if(!SELECTED_MODULE_ID) return;\n            const m = MODULES.find(mod => mod.id === SELECTED_MODULE_ID);\n            \n            if(type === 'el') m.status_el = document.getElementById('inspELStatus').value;\n            if(type === 'visual') m.status_visual = document.getElementById('inspVisualStatus').value;\n            if(type === 'iv') m.status_iv = document.getElementById('inspIVStatus').value;\n            \n            // Re-render map marker color immediately\n            if(mapMarkers[m.id]) {\n                mapMarkers[m.id].setStyle({ color: getStatusColor(m) });\n            }\n            renderModuleList();\n        }\n\n        async function saveInspector() {\n            // Here we would call API to save specific module changes\n            // For now, we rely on the global Save button\n            alert('Modifications appliqu\u00e9es localement. Cliquez sur \"Sauvegarder\" en haut pour persister.');\n        }\n\n        // --- VIEW SWITCHING ---\n        function switchView(mode) {\n            VIEW_MODE = mode;\n            if(mode === 'map') {\n                document.getElementById('mapContainer').classList.remove('hidden');\n                document.getElementById('schematicContainer').classList.add('hidden');\n                document.getElementById('btnViewMap').classList.add('bg-white', 'shadow-sm', 'text-purple-700');\n                document.getElementById('btnViewSchematic').classList.remove('bg-white', 'shadow-sm', 'text-purple-700');\n            } else {\n                document.getElementById('mapContainer').classList.add('hidden');\n                document.getElementById('schematicContainer').classList.remove('hidden');\n                document.getElementById('btnViewSchematic').classList.add('bg-white', 'shadow-sm', 'text-purple-700');\n                document.getElementById('btnViewMap').classList.remove('bg-white', 'shadow-sm', 'text-purple-700');\n            }\n        }\n    </script>\n</body>\n</html>\n";
